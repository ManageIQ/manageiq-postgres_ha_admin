#!/bin/env ruby

require 'bundler/setup'
require 'manageiq-postgres_ha_admin'
require 'linux_admin'
require 'logger'

ManageIQ::PostgresHaAdmin.logger = Logger.new("/var/www/miq/vmdb/log/ha_admin.log")

rails_handler = ManageIQ::PostgresHaAdmin::RailsConfigHandler.new(:file_path => "/var/www/miq/vmdb/config/database.yml", :environment => "production")
rails_handler.before_failover do
  LinuxAdmin::Service.new("evmserverd").stop
end

rails_handler.after_failover do
  LinuxAdmin::Service.new("evmserverd").restart
  require "awesome_spawn"

  rails_root = [
    Pathname.new("/var/www/miq/vmdb"),
    Pathname.new(File.expand_path(File.join(__dir__, "../..")))
  ].detect { |f| File.exist?(f) }
  AwesomeSpawn.run("rake evm:raise_server_event",
                   :chdir  => rails_root,
                   :params => ["--", {:event  => "db_failover_executed"}])
end

monitor = ManageIQ::PostgresHaAdmin::FailoverMonitor.new
monitor.add_handler(rails_handler)
monitor.monitor_loop
